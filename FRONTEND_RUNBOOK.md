# üß≠ Runbook: –∫–∞–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä—É —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–æ–µ–∫—Ç–æ–º

## 0) –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –∏ —Å—Å—ã–ª–∫–∏

**GitHub (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Ñ—Ä–æ–Ω—Ç–∞):**
https://github.com/swer4ock/swer4ock-analytics-ui

**–ü—Ä–æ–¥:**
https://swer4ock-analytics-ui-seven.vercel.app

**Vercel (–ø—Ä–æ–µ–∫—Ç):**
https://vercel.com/marsels-projects/swer4ock-analytics-ui

**Supabase (—ç—Ç–æ—Ç —Ñ—Ä–æ–Ω—Ç —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ RPC/REST):**
URL –∏ –∫–ª—é—á –±—Ä–∞—Ç—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–º. –Ω–∏–∂–µ).

## 1) –†–æ–ª–∏ –∏ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**–§—Ä–æ–Ω—Ç:** —Å–æ–∑–¥–∞—ë—Ç/–ø—Ä–∞–≤–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤—ã–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ RPC/Views —á–µ—Ä–µ–∑ REST –∏–ª–∏ @supabase/supabase-js, –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã/–≥—Ä–∞—Ñ–∏–∫–∏/—Ç–∞–±–ª–∏—Ü—ã, –ø–∏—à–µ—Ç UI/UX.

**–ë—ç–∫–µ–Ω–¥/–ë–∞–∑–∞:** –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ RPC-—Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–∞–≤–∏—Ç RLS, –º–µ–Ω—è–µ—Ç —Å—Ö–µ–º—ã, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç SQL.

–ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç—É –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö/–ø–æ–ª–µ–π ‚Üí —Å–æ–∑–¥–∞—ë—Ç issue "RPC request" (—à–∞–±–ª–æ–Ω –Ω–∏–∂–µ) ‚Äî –Ω–µ –ª–µ–∑–µ—Ç –≤ –ë–î.

## 2) –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)

```bash
# 1) –∫–ª–æ–Ω–∏—Ä—É–µ–º
git clone https://github.com/swer4ock/swer4ock-analytics-ui.git
cd swer4ock-analytics-ui

# 2) —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm i

# 3) —Å–æ–∑–¥–∞—ë–º .env.local
cp .env.example .env.local
# –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º:
# NEXT_PUBLIC_SUPABASE_URL=...
# NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# 4) —Å—Ç–∞—Ä—Ç
npm run dev
# http://localhost:3000
```

**–í–∞–∂–Ω–æ:** –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

## 3) –í–µ—Ç–∫–∏, –∫–æ–º–º–∏—Ç—ã, –¥–µ–ø–ª–æ–π

**–§–∏—á–∞-–≤–µ—Ç–∫–∏:** `feature/<slug>` (–Ω–∞–ø—Ä., `feature/analytics-filters`)

**–ö–æ–º–º–∏—Ç—ã:** `feat: ...`, `fix: ...`, `chore: ...`

**–ü—É–ª–ª-—Ä–µ–∫–≤–µ—Å—Ç** –≤ `main`. –ü–æ—Å–ª–µ –º—ë—Ä–¥–∂–∞ Vercel –¥–µ–ø–ª–æ–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ä—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π:
https://vercel.com/marsels-projects/swer4ock-analytics-ui ‚Üí Deployments ‚Üí Redeploy (Clear build cache).

## 4) –î–∞–Ω–Ω—ã–µ: —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ RPC (–≥–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã)

–§—Ä–æ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ RPC. –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ (—Å–º. –ø.7).

### 4.1 RPC: get_analytics_summary

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** KPI –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.

**–í—ã–∑–æ–≤ (REST):**
```
POST {NEXT_PUBLIC_SUPABASE_URL}/rest/v1/rpc/get_analytics_summary
Headers:
  apikey: {NEXT_PUBLIC_SUPABASE_ANON_KEY}
  Authorization: Bearer {NEXT_PUBLIC_SUPABASE_ANON_KEY}
  Content-Type: application/json
Body: {}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "total_ads": 209,
  "total_cities": 28,
  "total_contacts": 84,
  "avg_conversion": 0.67,
  "refreshed_at": "2025-09-08T10:21:00Z"
}
```

### 4.2 RPC: get_city_performance

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–ø-–≥–æ—Ä–æ–¥–æ–≤.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** `from_date`, `to_date`, `limit`

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (REST):**
```
POST .../rpc/get_city_performance
Body: {"from_date":"2025-08-01","to_date":"2025-09-08","limit":20}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–º–∞—Å—Å–∏–≤):**
```json
[
  {"city":"–ö–∞–∑–∞–Ω—å","contacts":13,"impressions":4650,"views":520,"view_to_contact":1.1},
  {"city":"–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã","contacts":6,"impressions":2100,"views":250,"view_to_contact":0.8}
]
```

### 4.3 RPC: get_strategy_monitoring

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–±–∏–¥–¥–µ—Ä–∞ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
[
  {"strategy_type":"priority","ads_count":72,"avg_cost_per_contact":480,"avg_conversion":1.05},
  {"strategy_type":"standard","ads_count":91,"avg_cost_per_contact":530,"avg_conversion":0.92}
]
```

‚ö†Ô∏è **–ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç—É –Ω—É–∂–Ω—ã –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ñ–∏–ª—å—Ç—Ä—ã/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)** ‚Äî —Å–º. –ø.7 (issue –Ω–∞ –±—ç–∫–µ–Ω–¥).

## 5) –ö–∞–∫ –≤—ã–∑—ã–≤–∞—Ç—å RPC –≤ –∫–æ–¥–µ (–¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)

### –í–∞—Ä–∏–∞–Ω—Ç A. –ß–µ—Ä–µ–∑ Supabase JS (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
```tsx
"use client";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export async function fetchSummary() {
  const { data, error } = await supabase.rpc("get_analytics_summary");
  if (error) throw error;
  return data;
}
```

### –í–∞—Ä–∏–∞–Ω—Ç B. –ü—Ä—è–º–æ–π REST fetch (SSR/–∫–ª–∏–µ–Ω—Ç)
```tsx
const url = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/rest/v1/rpc/get_city_performance`;
const res = await fetch(url, {
  method: "POST",
  headers: {
    apikey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    Authorization: `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({ limit: 20 }),
  cache: "no-store", // –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ª–∏–ø–∞–ª–æ –≤ –∫—ç—à–µ
});
const data = await res.json();
```

## 6) –°—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –º–∞—Ä—à—Ä—É—Ç—ã (–º–∏–Ω–∏–º—É–º –¥–ª—è MVP)

- `/` ‚Äî health: –ø–æ–∫–∞–∑–∞—Ç—å `NEXT_PUBLIC_SUPABASE_URL` (—á–∞—Å—Ç—å), –ø–∏–Ω–≥ RPC
- `/analytics` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:
  - KPI –∫–∞—Ä—Ç–æ—á–∫–∏ (–æ—Ç–≤–µ—Ç `get_analytics_summary`)
  - –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ä–æ–¥–æ–≤ (–æ—Ç–≤–µ—Ç `get_city_performance`)
  - –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (–æ—Ç–≤–µ—Ç `get_strategy_monitoring`)

**–í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–Ω–¥–µ—Ä–∏–º –±–µ–∑ –∫—ç—à–∞:**
```tsx
export const dynamic = "force-dynamic";
```

## 7) –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ—Å–∏—Ç—å –±—ç–∫–µ–Ω–¥ ¬´–¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ¬ª (—à–∞–±–ª–æ–Ω issue)

–°–æ–∑–¥–∞—ë–º issue –≤ https://github.com/swer4ock/swer4ock-analytics-ui –∏–ª–∏ –≤ —Ç—Ä–µ–∫–µ—Ä–µ –∑–∞–¥–∞—á, –∑–∞–≥–æ–ª–æ–≤–æ–∫:

```
RPC Request: get_city_performance ‚Äî add filters (city, strategy, date range)
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
```
–ó–∞—á–µ–º: –Ω—É–∂–µ–Ω —Ñ–∏–ª—å—Ç—Ä –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ –≥–æ—Ä–æ–¥–∞–º –∏ –¥–∞—Ç–∞–º
–ù—É–∂–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ: city, impressions, views, contacts, conversion_pct, cost_per_contact
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã RPC:
cities text[] NULL,
from_date date NULL,
to_date date NULL,
strategy_type text NULL
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: P2
–î–µ–¥–ª–∞–π–Ω: 2 –¥–Ω—è
–°–∫—Ä–∏–Ω: (–∫—É–¥–∞ —ç—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –Ω–∞ UI)
```

–ü–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±—ç–∫–µ–Ω–¥ –ø–æ–º–µ—Ç–∏—Ç issue `done` + –ø—Ä–∏–ª–æ–∂–∏—Ç –ø—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞.

## 8) –¢–µ—Å—Ç-—á–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø—É—à–µ–º

- ‚úÖ `npm run lint && npm run build` ‚Äî –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è `/` –∏ `/analytics`
- ‚úÖ RPC –æ—Ç–≤–µ—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
- ‚úÖ –ù–µ—Ç —Ç–∞–π–Ω—ã—Ö –∫–ª—é—á–µ–π –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ `NEXT_PUBLIC_*`)
- ‚úÖ UI –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (Tailwind responsive)

## 9) –¢—Ä–∏ —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –∫–∞–∫ –∏—Ö –æ–±—Ö–æ–¥–∏—Ç—å

**–ë–∏–ª–¥ –Ω–∞ Vercel –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ API route**
- –£–¥–∞–ª–∏—Ç—å/–ø–æ—á–∏–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π `app/api/.../route.ts` –ø–µ—Ä–µ–¥ –º—ë—Ä–¥–∂–µ–º –≤ `main`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ Vercel ‚Üí Deployments ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–∏–ª–¥

**RPC –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401/403**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel ‚Üí Project ‚Üí Settings ‚Üí Environment Variables
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ RPC –∏–º–µ–µ—Ç `SECURITY DEFINER` –∏ —Ä–∞–∑—Ä–µ—à—ë–Ω –¥–ª—è `anon`

**–ù–∞ –ø—Ä–æ–¥–µ –ø—É—Å—Ç–æ, –ª–æ–∫–∞–ª—å–Ω–æ –æ–∫**
- –ù–∞ Vercel —Å–¥–µ–ª–∞—Ç—å Redeploy —Å Clear build cache
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—ã–∑–æ–≤—ã –ø–æ–º–µ—á–µ–Ω—ã `cache: "no-store"` –∏–ª–∏ `dynamic = "force-dynamic"`

## 10) –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–¥

–ú—ë—Ä–¥–∂ –≤ `main` ‚Üí Vercel —Å–∞–º –∑–∞–¥–µ–ø–ª–æ–∏—Ç.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä—É–∫–∞–º–∏:
https://vercel.com/marsels-projects/swer4ock-analytics-ui ‚Üí Deployments ‚Üí Redeploy ‚Üí Clear build cache.

## 11) –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è ¬´–µ—â—ë –≤—á–µ—Ä–∞¬ª

**–ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥–ª—É—à–∫–∞:** –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏ (json), –∑–∞—Ç–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤–æ–º RPC.

–ï—Å–ª–∏ ¬´–≥–æ—Ä–∏—Ç¬ª –ø–æ –¥–∞–Ω–Ω—ã–º ‚Äî –∑–∞–≤–æ–¥–∏–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–¥–∞—á—É –Ω–∞ –±—ç–∫–µ–Ω–¥ (—Å–º. –ø.7) –∏ —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –≤ UI "–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –≤ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏".

## 12) –ö–æ–Ω—Ç–∞–∫—Ç—ã –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞

**Vercel –ø—Ä–æ–µ–∫—Ç (–¥–µ–ø–ª–æ–π/–ª–æ–≥–∏):**
https://vercel.com/marsels-projects/swer4ock-analytics-ui

**GitHub (–∫–æ–¥/issue):**
https://github.com/swer4ock/swer4ock-analytics-ui

---

## –ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä—É

1. –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ, –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∑–∞–ø–æ–ª–Ω–∏—Ç—å `.env.local`
2. –û—Ç–∫—Ä—ã—Ç—å `/analytics`, –ø–æ–¥—Ü–µ–ø–∏—Ç—å —Ç—Ä–∏ RPC (—Å–º. –ø.4, –ø.5)
3. –í—ã–≤–µ—Å—Ç–∏ KPI + –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã
4. –°–¥–µ–ª–∞—Ç—å PR ‚Üí –º—ë—Ä–¥–∂ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥
5. –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–≤–µ—Å—Ç–∏ issue "RPC Request" –ø–æ —à–∞–±–ª–æ–Ω—É (–ø.7)

–ì–æ—Ç–æ–≤–æ. –° —Ç–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π —Ñ—Ä–æ–Ω—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ, –∞ —Ç—ã ‚Äî –Ω–µ –ª–æ–≤–∏—Ç—å ¬´—Å—é—Ä–ø—Ä–∏–∑—ã¬ª –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º.
